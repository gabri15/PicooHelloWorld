name: Ejecutar Playwright

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

on:
  schedule:
    # 18:00 UTC = 19:00 EspaÃ±a (Invierno/Horario EstÃ¡ndar)
    # 18:00 UTC = 20:00 EspaÃ±a (Verano)
    - cron: "20 18 * * *"
  
  workflow_dispatch: # BotÃ³n manual
  
  push:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Run Playwright tests
        env:
          USAL_USERNAME: ${{ secrets.MI_SUPER_USUARIO }}
          USAL_PASSWORD: ${{ secrets.MI_SUPER_PASSWORD }}
        run: npx playwright test

      # ðŸ”¹ Prepara contenido para GitHub Pages
      - name: Prepare Pages content
        if: always()
        run: |
          mkdir -p public/test-results/extracted-data
          if [ -f test-results/extracted-data/all-results.json ]; then
            cp test-results/extracted-data/all-results.json public/test-results/extracted-data/all-results.json
          else
            echo "No existe all-results.json; publicando placeholder"
            echo '{}' > public/test-results/extracted-data/all-results.json
          fi

          cat > public/index.html <<'HTML'
          <!doctype html>
          <html lang="es">
          <head>
            <meta charset="utf-8">
            <title>Resultados Playwright</title>
          </head>
          <body>
            <h1>Resultados Playwright</h1>
            <ul>
              <li><a href="./test-results/extracted-data/all-results.json">all-results.json</a></li>
            </ul>
            <pre id="out">Cargandoâ€¦</pre>
            <script>
              fetch('./test-results/extracted-data/all-results.json')
                .then(r => r.json())
                .then(j => out.textContent = JSON.stringify(j, null, 2))
                .catch(e => out.textContent = e.toString());
            </script>
          </body>
          </html>
          HTML

      # ðŸ”¹ Subir artefacto para Pages (USANDO NOMBRE POR DEFECTO)
      - name: Upload Pages artifact
        if: always()
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

  deploy:
    if: always()
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        # No especificamos artifact_name, usarÃ¡ el default que subiÃ³ el paso anterior